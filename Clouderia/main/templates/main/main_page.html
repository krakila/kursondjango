{% extends 'base.html' %}
{% block content %}
<html lang="ru">
<head>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta charset="UTF-8">
    <title>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</title>

    <style>
        .nav-bar {
            display: flex;
            justify-content: space-around;
            background-color: #333;
            padding: 10px;
        }
        .nav-bar a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
        }
        .nav-bar a:hover {
            background-color: #555;
        }
    </style>
    <style>
        .work-container {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .buttons {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 10px;
        }
        .buttons button {
            padding: 5px 10px;
        }
        .avatar img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <a href="{% url 'main_page' %}">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="{% url 'user_profile' user.username %}">–ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="{% url 'profile_settings' %}">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
        <a href="{% url 'storage:storage_view' %}">–•—Ä–∞–Ω–∏–ª–∏—â–µ</a> <!-- –ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ -->
    </div>


    <h1>–†–∞–±–æ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h1>
    <!-- –ü–æ–∏—Å–∫–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ -->
    <div>
        <form method="GET" action="{% url 'main_page' %}">
            <input type="text" name="query" placeholder="–ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç..." value="{{ request.GET.query }}">
            <button type="submit">üîç –ù–∞–π—Ç–∏</button>
        </form>
    </div>

    <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
    <div>
        <a href="?sort=date_desc">–ù–æ–≤—ã–µ</a> |
        <a href="?sort=date_asc">–°—Ç–∞—Ä—ã–µ</a> |
        <a href="?sort=likes">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</a> |
        <a href="?sort=user_popularity">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
    </div>
    <a href="{% url 'upload_file' %}" class="btn btn-primary mb-3">–î–æ–±–∞–≤–∏—Ç—å Cloud</a>
    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç -->
    {% for work in works %}
    <div class="work-container">
        <h2>{{ work.title }}</h2>
        {% if work.image %}
            <img src="{{ work.image.url }}" alt="{{ work.title }}" width="300">
        {% endif %}
        <p>{{ work.description }}</p>

        <div class="buttons">
            <a href="{% url 'view_work' work.id %}"><button>üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</button></a>
            <a href="{% url 'report_work' work.id %}"><button>‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</button></a>
            <button class="like-btn" data-work-id="{{ work.id }}">üëç –õ–∞–π–∫</button>
            <span id="likes-count-{{ work.id }}">{{ work.total_likes }}</span>
            <button class="dislike-btn" data-work-id="{{ work.id }}">üëé –î–∏–∑–ª–∞–π–∫</button>
            <span id="dislikes-count-{{ work.id }}">{{ work.total_dislikes }}</span>
        </div>

        <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="avatar">
            <a href="{% url 'user_profile' work.user.user.username %}">
                <img src="{{ work.user.avatar.url }}" alt="{{ work.user.user.username }}">
            </a>
        </div>
    </div>
    {% endfor %}
</body>
</html>
{% endblock %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeButtons = document.querySelectorAll('.like-btn');  // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
    const dislikeButtons = document.querySelectorAll('.dislike-btn');

    likeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const workId = this.dataset.workId;
            fetch(`/main/like/${workId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`likes-count-${workId}`).textContent = data.likes;
                document.getElementById(`dislikes-count-${workId}`).textContent = data.dislikes;
            });
        });
    });

    dislikeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const workId = this.dataset.workId;
            fetch(`/main/dislike/${workId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`likes-count-${workId}`).textContent = data.likes;
                document.getElementById(`dislikes-count-${workId}`).textContent = data.dislikes;
            });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

</script>
